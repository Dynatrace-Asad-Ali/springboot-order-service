name: Deploy on Merge

on:
  push:
    branches:
      - main
    paths:
      - 'deployment/version.txt'

jobs:
  detect-version-change:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.read-version.outputs.version }}
      previous_version: ${{ steps.get-previous.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Need 2 commits to compare
      
      - name: Read target version
        id: read-version
        run: |
          VERSION=$(cat deployment/version.txt | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Target deployment version: $VERSION"
      
      - name: Get previous version
        id: get-previous
        run: |
          git checkout HEAD~1
          PREV_VERSION=$(cat deployment/version.txt 2>/dev/null | tr -d '[:space:]' || echo "unknown")
          echo "version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREV_VERSION"
      
      - name: Determine if this is a rollback
        id: check-rollback
        run: |
          CURRENT="${{ steps.read-version.outputs.version }}"
          PREVIOUS="${{ steps.get-previous.outputs.version }}"
          
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "Version changed from $PREVIOUS to $CURRENT"
            echo "is_deployment=true" >> $GITHUB_OUTPUT
          else
            echo "No version change detected"
            echo "is_deployment=false" >> $GITHUB_OUTPUT
          fi

  deploy-to-vm:
    name: Deploy Release to VM
    needs: detect-version-change
    if: needs.detect-version-change.outputs.version != ''
    runs-on: ubuntu-latest
    
    steps:            
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
      
      - name: Pre-deployment checks
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'ENDSSH'
            # Check application status
            running=$(ps -ef | grep OrderServiceLoadGenerator | grep -v grep | wc -l)
            if [ "$running" -gt 0 ]; then
              echo "✓ Application is running"
            else
              echo "⚠️  Warning: Application is not running"
            fi
          ENDSSH
      - name: Stop Application on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Stopping Application ==="
            
            # Find process - try multiple patterns
            PID=$(ps -ef | grep OrderServiceLoadGenerator | grep -v grep | awk '{print $2}')
            
            # Alternative if first method doesn't work
            if [ -z "$PID" ]; then
              PID=$(ps -ef | grep "springboot-order-service" | grep -v grep | awk '{print $2}')
            fi
            
            # Another alternative
            if [ -z "$PID" ]; then
              PID=$(pgrep -f "OrderServiceLoadGenerator")
            fi
            
            if [ -z "$PID" ]; then
              echo "⚠️  No process found (may not be running)"
            else
              echo "Found PID: $PID"
              
              # Kill process
              kill $PID || true
              
              # Wait for shutdown
              for i in {1..10}; do
                if ! ps -p $PID > /dev/null 2>&1; then
                  echo "✓ Process stopped"
                  break
                fi
                sleep 1
              done
              
              # Force kill if still running
              if ps -p $PID > /dev/null 2>&1; then
                echo "Force killing..."
                kill -9 $PID || true
              fi
            fi
            
            echo "=== Stop Complete ==="

      - name: Download and deploy release
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << ENDSSH
            set -e
            cd /home/ubuntu/dev/springboot-order-service
            # Deploy new version
            mvn exec:java -Dexec.mainClass="com.example.ecommerce.loadtest.OrderServiceLoadGenerator" -Dexec.args="-f -r 5 -t 5 -s 0"            
            echo "✓ Deployment initiated"
          ENDSSH
      
